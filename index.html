<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Offline Maps by sebastian-meier</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>Offline Maps</h1>
        <h2>for Mobile or Tablet</h2>
        <p>Leaflet + PhoneGap<br />(or any other Cordova based wrapper)</p>
        <p class="view"><a href="https://github.com/sebastian-meier/OfflineMaps">View the Project on GitHub:<br /><small>sebastian-meier/OfflineMaps</small></a></p>
        <ul>
          <li><a href="https://github.com/sebastian-meier/OfflineMaps/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/sebastian-meier/OfflineMaps/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/sebastian-meier/OfflineMaps">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h3><a name="why" class="anchor" href="#why"><span class="octicon octicon-link"></span></a>Why?</h3>
        <p>If you are developing web-apps for mobile devices wrapped in something like PhoneGap, Icenium, etc. you may come to a point where you want to enable your users to use maps even though they are not online. Especially when you are on vacation in a foreign country or you are just in the underground and have no mobile reception.</p>
        <p>There are two ways to achive an offline map. The first is simple, create an mbtile file with TileMill and use the <a href="https://github.com/mapbox/mbutil">mbutil</a> to extract folders and pngs. This folder can simply be added to your web app and you can define the folder as an url for your leaflet TileLayer. BUT, using this method you end up with a huge amount of files, which need to be copied to your testing device every time you run your application and this takes ages. So for better handling it is adviced to use the mbtiles files created by MapBox for exactly this purpose, better handling. For those who quickly want to know what mbtiles files are: those files are SQLite Databases holding all tile images of your exported map. You can very easily use this Firefox Extension <a href="https://addons.mozilla.org/de/firefox/addon/sqlite-manager/">SQLite-Manager</a> to look into an mbtile and see the tiles.</p>
      </section>
      <section>
        <h3><a name="setup" class="anchor" href="#setup"><span class="octicon octicon-link"></span></a>Setup</h3>
        <p>First of all we need a map. We will use a mbtile file exported from <a href="http://www.mapbox.com/tilemill/">TileMill</a>. The mbtile file in this repository is an export from the Washingtion DC sample included in the TileMill Application. <i>Important: as the javascript sqlite library will automatically add a ".db" extension to your mbtile file name, you need to add this manually to the file itself.</i></p>
        <p>After the map creation we need our native wrapper. In this example we use <a href="http://phonegap.com/">PhoneGap</a>, but you could essentially use any Cordova (Apache) based wrapper. PhoneGap comes with a command line tool that helps you create your projects:</p>
        <pre><code>$ your_phonegap_folder/lib/ios/bin/create new_project_folder com.company.project project_name</code></pre>
        <p>After installation we open the project in xCode and add the <a href="https://github.com/pgsqlite/PG-SQLitePlugin-iOS">SQLite Plugin</a> (by <a href="https://github.com/pgsqlite" class="user-mention">pgsqlite</a>) to the plugins folder. Go to config.xml and add these lines (Depending on the PhoneGap version you are using, this might be a plist file):</p>
        <pre><code>&lt;feature name="SQLitePlugin"&gt;
&lt;param name="ios-package" value="SQLitePlugin" /&gt;
&lt;/feature&gt;</code></pre>
        <p>Now go to your target in xcode and add the "sqlite3.dylib" library to the "Linked Frameworks and Libraries" (see image below). Then add the mbtile file created in the first step to your resources in xcode.</p>
        <div class="image-container">
          <img src="images/xcode_1.png" alt="Adding the sqlite library in xCode Step 1" />
          <span class="image-subline">Adding the sqlite library in xCode Step 1</span>
        </div>
        <div class="image-container">
          <img src="images/xcode_2.png" alt="Adding the sqlite library in xCode Step 2" />
          <span class="image-subline">Adding the sqlite library in xCode Step 2</span>
        </div>
        <p>To enable the sqlite library to access our database file, we need to copy it to the right location on startup. Therefore we need to commentout the function "webViewDidStartLoad" and modify it:</p>
        <pre><code>- (void) webViewDidStartLoad:(UIWebView*)theWebView
{
    NSString *databaseName = @"map.mbtiles.db";
    
    NSArray *libraryPaths = NSSearchPathForDirectoriesInDomains(NSLibraryDirectory, NSUserDomainMask, YES);
    NSString *libraryDir = [libraryPaths objectAtIndex:0];
    
    NSString *databasePath = [libraryDir stringByAppendingPathComponent:@"../Documents/Databases/"];
    NSString *databaseFile = [databasePath stringByAppendingPathComponent:databaseName];
    
    BOOL success;
    NSFileManager *fileManager = [NSFileManager defaultManager];
    
    success = [fileManager fileExistsAtPath:databasePath];
    if(success) return;
    
    NSString *databasePathFromApp = [[[NSBundle mainBundle] resourcePath] stringByAppendingPathComponent:databaseName];
    
    [fileManager createDirectoryAtPath:databasePath withIntermediateDirectories:YES attributes:nil error:NULL];
    [fileManager copyItemAtPath:databasePathFromApp toPath:databaseFile error:nil];
    [fileManager release];
    
    return [super webViewDidStartLoad:theWebView];
}</code></pre>
        <p>What we do here is simply checking on every startup of the application if the database file has already been copied to our defined destination or not. If not the file is copied. If your curious about the structur of the apps data directory you can see the structure if you go to:</p>
        <code><pre>/Usr/Library/Application&nbsp;Support/iPhone&nbsp;Simulator/iOS_of_you_choice/...</pre></code>
        <p>The interesting part is writing the html/javascript code that creates the map and connects it via the sqlite plugin to our mbtiles file. We will use the phonegap sample files. First of all you need to add the <a href="http://leafletjs.com/">leaflet</a> javascript library and stylesheet. You could use the hosted version, but as we want to build an offline app, you should include the latest version from the leaflet website directly into your application. In addition we need the sqlite-plugin-file (included in the pgsqlite's <a href="https://github.com/pgsqlite/PG-SQLitePlugin-iOS">repository</a>) and make sure the cordova library is still in the www folder. The following lines will take care of map &amp; sqlite creation:</p>
         <pre><code>onDeviceReady: function() {
  console.log("onDeviceReady");

  //the "db" extension is added by the library
  app.db = window.sqlitePlugin.openDatabase({name: "/Databases/map.mbtiles"});
  
  //lets test if our database works, the following sql query selects our maximum zoom level
  app.db._executeSql(
    //query
    "SELECT DISTINCT zoom_level FROM tiles ORDER BY zoom_level DESC LIMIT 1;", 
    //parameters
    [], 
    //success
    function(res) {
      console.log("success");
      //initialize Leaflet
      app.map = new L.map('map', {center:[38.8977, -77.0365], zoom: 15});
      //create MBTiles Layer
      var tile = new L.TileLayer.MBTiles('', {maxZoom: 19, tms: true, scheme: 'tms', unloadInvisibleTiles:true}, app.db);
      tile.addTo(app.map);

    },
    //error
    function(e) {
      console.log("error");
      console.log(e);
    }
  );

}</code></pre>
        <p>Last but not least we need to add the MBTiles Plugin. This plugin was taken from... and slightly modified to work with the sqlite Libraries. Comment: the leaflet documentation says that you can set the layer property tms:true, but i couldn't get it to work. So i just added the lines:</p>
        <pre><code>var limit = this._getWrapTileNum();
var y = limit - tilePoint.y - 1;</code></pre>
        <p>The numbering of tilemills y-coordinate is in reverse order, this lines take care that the leaflet order is translated into tilemill order.</p>
        <p>If everything went smoothly you should now have an offline-map engine that should look like this:</p>
        <div class="image-container">
          <img src="images/app.png" alt="Offline Map App Screenshot" />
          <span class="image-subline">Offline Map App Screenshot</span>
        </div>
      </section>
      <footer>
        <p>This project is maintained by <a href="https://github.com/sebastian-meier">sebastian-meier</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
  </body>
</html>
